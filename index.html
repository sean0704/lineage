<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地監冒險 (優化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            overflow: hidden; /* 避免載入時出現捲軸 */
        }
        .game-container {
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 100%;
            padding: 1.5rem;
            border: 2px solid #4a5568;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; 
        }
        .header h2 {
            font-size: 2rem; 
            font-weight: 700;
            color: #a0aec0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        .status-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background-color: #4a5568;
            padding: 0.25rem;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid #5a6478;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        .stat-item {
            background-color: #3a4352;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .stat-item .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #e2e8f0;
        }
        .stat-item .label {
            font-size: 0.8rem;
            color: #a0aec0;
        }
        .game-output {
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 1rem;
            height: 125px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 1rem;
            line-height: 1.5;
            color: #e2e8f0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }
        .game-button {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            flex-grow: 1;
            min-width: 120px;
        }
        .game-button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
        }
        .game-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .red-button { background-color: #e53e3e; }
        .red-button:hover { background-color: #c53030; }
        .green-button { background-color: #48bb78; }
        .green-button:hover { background-color: #38a169; }
        .gray-button { background-color: #718096; }
        .gray-button:hover { background-color: #4a5568; }

        .list-container {
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 1rem;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-top: 1rem;
        }
        .list-container ul { list-style: none; padding: 0; margin: 0; }
        .list-container li {
            padding: 0.5rem;
            border-bottom: 1px dashed #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .list-container li:hover { background-color: #3a4352; border-radius: 0.5rem; }
        .list-container li:last-child { border-bottom: none; }
        .list-container li .item-name { flex-grow: 1; }
        .list-container li .item-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .list-container li button {
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .equip-btn { background-color: #63b3ed; }
        .equip-btn:hover { background-color: #4299e1; }
        .use-btn { background-color: #a0aec0; }
        .use-btn:hover { background-color: #718096; }
        
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: #2d3748; padding: 2rem; border-radius: 1.0rem;
            text-align: center; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            border: 2px solid #4a5568; max-width: 90%; width: 500px;
        }
        .modal-content h2 { font-size: 2rem; color: #a0aec0; margin-bottom: 1rem; }
        .modal-content p { font-size: 1.2rem; margin-bottom: 1.5rem; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: left; margin-bottom: 1.5rem; }
        .comparison-grid h3 { font-weight: bold; color: #718096; border-bottom: 1px solid #4a5568; padding-bottom: 0.5rem; }
        .stat-change-loss { color: #f56565; }
        .stat-change-gain { color: #48bb78; }

        .health-bar-wrapper {
            width: 100%; margin: 0.5rem 0; background-color: #3a4352;
            border-radius: 0.75rem; padding: 0.5rem; position: relative;
            height: 2.5rem; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .health-bar-container {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            background-color: #555; border-radius: 0.5rem; overflow: hidden;
        }
        .health-bar-fill {
            height: 100%; background: linear-gradient(to right, #e53e3e, #c53030);
            width: 100%; transition: width 0.5s ease-in-out; border-radius: 0.5rem;
        }
        .health-bar-text {
            position: absolute; color: white; font-weight: bold; text-shadow: 1px 1px 2px black;
        }
        
        #monsterImageContainer {
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }
        #monsterImage {
            max-height: 100%;
            max-width: 100%;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- 載入畫面 -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #1a202c; z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s ease;">
        <h2 style="color: #a0aec0; font-size: 2rem; margin-bottom: 1.5rem;">遊戲資源載入中...</h2>
        <div id="progressBarContainer" style="width: 80%; max-width: 400px; background-color: #4a5568; border-radius: 0.5rem; overflow: hidden; border: 1px solid #5a6478;">
            <div id="progressBar" style="width: 0%; height: 2rem; background-color: #4299e1; transition: width 0.3s ease;"></div>
        </div>
        <p id="progressText" style="color: #e2e8f0; margin-top: 1rem; font-size: 1.1rem;">0 / 0</p>
    </div>

    <!-- 遊戲主體 -->
    <div id="gameContainer" class="game-container" style="visibility: hidden;">
        <div class="header text-center mb-1"> 
            <h2>地監冒險</h2>
        </div>

        <div id="monsterImageContainer">
            <img id="monsterImage" src="" alt="Monster Image" style="display: none;">
        </div>

        <div class="status-bar">
            <div class="health-bar-wrapper">
                <div id="playerHealthBarContainer" class="health-bar-container">
                    <div id="playerHealthBarFill" class="health-bar-fill"></div>
                </div>
                <div id="playerHealthText" class="health-bar-text"></div>
            </div>
        </div>

        <div id="gameOutput" class="game-output"></div>
        <div id="buttonGroup" class="button-group"></div>
        <div id="inventoryDisplay" class="list-container hidden"></div>
        
        <div class="stats-grid mt-4">
            <div class="stat-item"><div id="playerGold" class="value"></div><div class="label">金幣</div></div>
            <div class="stat-item"><div id="playerAttack" class="value"></div><div class="label">攻擊力</div></div>
            <div class="stat-item"><div id="playerDefense" class="value"></div><div class="label">防禦力</div></div>
            <div class="stat-item"><div id="playerLevel" class="value"></div><div class="label">等級</div></div>
            <div class="stat-item"><div id="playerXP" class="value"></div><div class="label">經驗值</div></div>
            <div class="stat-item"><div id="currentFloor" class="value"></div><div class="label">樓層</div></div>
        </div>

        <div id="equippedItemsDisplay" class="list-container">
            <h3 class="text-xl font-bold mb-2 text-center text-gray-300">
                已裝備物品
                <button id="toggleEquippedButton" class="text-sm px-2 py-1 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors ml-2">展開</button>
            </h3>
            <div id="equippedListContainer" class="hidden">
                <ul id="equippedList"></ul>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="gameOverModal" class="modal hidden"><div class="modal-content"><h2>遊戲結束！</h2><p id="gameOverMessage"></p><button id="restartButton" class="game-button green-button">重新開始</button></div></div>
    <div id="equipConfirmModal" class="modal hidden"><div class="modal-content"><h2 id="equipModalTitle">確認裝備</h2><div id="equipComparison" class="comparison-grid"></div><div class="flex justify-center gap-4"><button id="confirmEquipButton" class="game-button green-button">確認</button><button id="cancelEquipButton" class="game-button gray-button">取消</button></div></div></div>

    <script>
    const Game = {
        DOM: {},
        CONSTANTS: {
            MAX_DUNGEON_FLOOR: 7,
            EXPLORATIONS_PER_FLOOR: 10,
            MONSTER_HP_SCALING: 0.2,
            MONSTER_ATTACK_SCALING: 0.1,
        },
        state: {
            player: null,
            currentMonster: null,
            gamePhase: 'start',
            lastMajorPhase: 'start',
        },
        data: {
            monsters: {},
            items: {},
            floorMonsterPools: {},
            soundMap: {
                'attack': 'https://actions.google.com/sounds/v1/weapons/sword_hit.ogg', // 範例音效
                'encounter': 'https://actions.google.com/sounds/v1/monsters/monster_growl.ogg', // 範例音效
                'victory': 'https://actions.google.com/sounds/v1/emergency/emergency_siren_long.ogg', // 範例音效
                'levelUp': 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg', // 範例音效
                'gameOver': 'https://actions.google.com/sounds/v1/human_voices/human_scream.ogg', // 範例音效
            }
        },

        AssetLoader: {
            assetsToLoad: [],
            loadedAssets: new Map(),
            
            loadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => { this.loadedAssets.set(src, img); resolve(img); };
                    img.onerror = () => reject(new Error(`無法載入圖片: ${src}`));
                });
            },

            loadAudio(src) {
                return new Promise((resolve, reject) => {
                    const audio = new Audio();
                    audio.src = src;
                    audio.oncanplaythrough = () => { this.loadedAssets.set(src, audio); resolve(audio); };
                    audio.onerror = () => reject(new Error(`無法載入音訊: ${src}`));
                });
            },

            async start() {
                console.log("開始預載資源...");
                const domProgressBar = document.getElementById('progressBar');
                const domProgressText = document.getElementById('progressText');
                
                this.assetsToLoad = [];
                for (const key in Game.data.monsters) { if (Game.data.monsters[key].image) this.assetsToLoad.push(Game.data.monsters[key].image); }
                for (const key in Game.data.items) { if (Game.data.items[key].image) this.assetsToLoad.push(Game.data.items[key].image); }
                for (const key in Game.data.soundMap) { this.assetsToLoad.push(Game.data.soundMap[key]); }
                
                const totalAssets = this.assetsToLoad.length;
                if (totalAssets === 0) { console.log("沒有需要預載的資源。"); return; }

                let loadedCount = 0;
                domProgressText.textContent = `${loadedCount} / ${totalAssets}`;

                const promises = this.assetsToLoad.map(src => {
                    let promise;
                    if (/\.(jpe?g|png|gif|svg)$/i.test(src)) promise = this.loadImage(src);
                    else if (/\.(mp3|wav|ogg)$/i.test(src)) promise = this.loadAudio(src);
                    else promise = Promise.resolve();
                    
                    return promise.catch(err => console.error(err)).then(() => {
                        loadedCount++;
                        const progress = (loadedCount / totalAssets) * 100;
                        domProgressBar.style.width = `${progress}%`;
                        domProgressText.textContent = `${loadedCount} / ${totalAssets}`;
                    });
                });

                await Promise.all(promises);
                console.log("所有資源載入完成！");
            }
        },

        async init() {
            this.cacheDOMElements();
            this.loadData();
            try {
                await this.AssetLoader.start();
                this.DOM.loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    this.DOM.loadingScreen.style.display = 'none';
                    this.DOM.gameContainer.style.visibility = 'visible';
                }, 500);
                this.bindEvents();
                this.resetGame();
            } catch (error) {
                console.error("資源載入失敗:", error);
                document.getElementById('progressText').textContent = `資源載入失敗: ${error.message}`;
            }
        },

        cacheDOMElements() {
            const ids = ['loadingScreen', 'gameContainer', 'monsterImageContainer', 'monsterImage', 'playerHealthBarFill', 'playerHealthText', 'equippedList', 'playerGold', 'playerAttack', 'playerDefense', 'playerLevel', 'playerXP', 'currentFloor', 'gameOutput', 'buttonGroup', 'inventoryDisplay', 'gameOverModal', 'gameOverMessage', 'restartButton', 'toggleEquippedButton', 'equippedListContainer', 'equipConfirmModal', 'equipModalTitle', 'equipComparison', 'confirmEquipButton', 'cancelEquipButton'];
            ids.forEach(id => { this.DOM[id] = document.getElementById(id); });
        },
        
        loadData() {
            // TODO: 請在此處為您的物品和怪物加上 image 屬性
            // 範例: image: 'images/goblin.png'
            // 為了方便測試，我先使用預留位置圖片
            this.data.items = {
                'dagger': { name: '匕首', type: 'weapon', slot: 'rightHand', sell: 55, attack: 3, defense: 0, rarity: 'common' },
                'shortBow': { name: '短弓', type: 'weapon', slot: 'rightHand', sell: 50, attack: 4, defense: 0, rarity: 'common' },
                'woodenShield': { name: '木盾', type: 'armor', slot: 'leftHand', sell: 30, defense: 1, rarity: 'common' },
                'redPotion': { name: '紅色藥水', type: 'potion', sell: 20, effect: { type: 'heal', amount: 30 } },
            };
            this.data.monsters = {
                'goblin': { name: '妖魔', level: 20, hp: 80, attack: 16, goldMin: 200, goldMax: 400, xpReward: 100, drops: [{ itemKey: 'redPotion', chance: 0.3 }], image: 'https://placehold.co/150x150/2c6e49/FFFFFF?text=Goblin' },
                'goblinArcher': { name: '妖魔弓箭手', level: 22, hp: 88, attack: 18, goldMin: 220, goldMax: 440, xpReward: 110, drops: [{ itemKey: 'shortBow', chance: 0.1 }], image: 'https://placehold.co/150x150/4c956c/FFFFFF?text=Goblin+Archer' },
                'skeleton': { name: '骷髏', level: 20, hp: 80, attack: 16, goldMin: 200, goldMax: 400, xpReward: 100, drops: [], image: 'https://placehold.co/150x150/a0aec0/FFFFFF?text=Skeleton' },
                'deathKnight': { name: '死亡騎士', level: 85, hp: 850, attack: 85, goldMin: 8000, goldMax: 20000, xpReward: 1000, drops: [{ itemKey: 'twoHandedSword', chance: 0.2 }, { itemKey: 'ironArmor', chance: 0.15 }, { itemKey: 'bravePotion', chance: 0.5 }], image: 'https://placehold.co/150x150/1a202c/FFFFFF?text=Death+Knight' },
            };
            this.data.floorMonsterPools = { 1: ['goblin', 'goblinArcher', 'skeleton'], 2: ['goblin', 'goblinArcher', 'skeleton'], 3: ['goblin', 'goblinArcher', 'skeleton'], 4: ['goblin', 'goblinArcher', 'skeleton'], 5: ['goblin', 'goblinArcher', 'skeleton'], 6: ['goblin', 'goblinArcher', 'skeleton'], 7: ['deathKnight', 'goblin', 'skeleton'] };
        },

        bindEvents() {
            this.DOM.restartButton.addEventListener('click', () => this.resetGame());
            this.DOM.toggleEquippedButton.addEventListener('click', () => this.toggleEquippedDisplay());
            this.DOM.cancelEquipButton.addEventListener('click', () => this.DOM.equipConfirmModal.classList.add('hidden'));
        },

        resetGame() {
            this.state.player = this.getInitialPlayerState();
            this.state.currentMonster = null;
            this.DOM.monsterImage.style.display = 'none';
            this.DOM.gameOverModal.classList.add('hidden');
            this.setOutput('你已在木人場訓練有成！準備好進入地監冒險了嗎?');
            this.setPhase('start');
        },

        getInitialPlayerState() { /* ... 內容不變 ... */ return { hp: 100, maxHp: 100, gold: 500, baseAttack: 18, baseDefense: 4, level: 5, xp: 0, xpToNextLevel: this.getXpRequiredForLevel(5), inventory: [], equipped: { head: null, body: null, legs: null, rightHand: null, leftHand: null }, currentFloor: 1, explorationsOnFloor: 0 }; },
        
        updateUI() { /* ... 內容不變 ... */ this.updateStatus(); },
        updateStatus() {
            const p = this.state.player;
            const stats = this.calculatePlayerStats();
            this.DOM.playerHealthBarFill.style.width = `${(p.hp / p.maxHp) * 100}%`;
            this.DOM.playerHealthText.textContent = `${p.hp} / ${p.maxHp}`;
            this.DOM.playerGold.textContent = p.gold;
            this.DOM.playerAttack.textContent = stats.attack;
            this.DOM.playerDefense.textContent = stats.defense;
            this.DOM.playerLevel.textContent = p.level;
            this.DOM.playerXP.textContent = `${p.xp} / ${p.xpToNextLevel}`;
            this.DOM.currentFloor.textContent = p.currentFloor;
            this.renderEquippedItems();
        },
        
        renderButtons(buttonArray) { /* ... 內容不變 ... */ this.DOM.buttonGroup.innerHTML = ''; buttonArray.forEach(btn => { const button = document.createElement('button'); button.textContent = btn.text; button.className = btn.className || 'game-button'; button.onclick = btn.action; button.disabled = btn.disabled || false; this.DOM.buttonGroup.appendChild(button); }); },
        renderEquippedItems() { /* ... 內容不變 ... */ this.DOM.equippedList.innerHTML = ''; const slotOrder = { head: '頭部', body: '身體', legs: '腿部', rightHand: '右手', leftHand: '左手' }; for(const slotKey in slotOrder) { const li = document.createElement('li'); const itemKey = this.state.player.equipped[slotKey]; let text = `${slotOrder[slotKey]}: `; if (itemKey) { text += this.getFormattedItemName(itemKey); const unequipBtn = document.createElement('button'); unequipBtn.textContent = '卸下'; unequipBtn.className = 'equip-btn'; unequipBtn.onclick = () => this.unequipItem(slotKey); li.innerHTML = `<span class="item-name">${text}</span>`; li.appendChild(unequipBtn); } else { text += '無'; li.innerHTML = `<span class="item-name">${text}</span>`; } this.DOM.equippedList.appendChild(li); } },
        toggleEquippedDisplay() { /* ... 內容不變 ... */ const isHidden = this.DOM.equippedListContainer.classList.toggle('hidden'); this.DOM.toggleEquippedButton.textContent = isHidden ? '展開' : '收合'; },

        setPhase(newPhase) {
            this.state.gamePhase = newPhase;
            this.DOM.inventoryDisplay.classList.add('hidden');
            if (newPhase !== 'combat') this.DOM.monsterImage.style.display = 'none';
            switch (newPhase) {
                case 'start': this.showStartOptions(); break;
                case 'village': this.showVillageOptions(); break;
                case 'explore': this.showExploreOptions(); break;
                case 'combat': this.showCombatOptions(); break;
            }
            this.updateUI();
        },
        
        showStartOptions() { this.renderButtons([{ text: '進入地監', action: () => this.enterDungeon() }]); },
        enterDungeon() { this.setOutput(`你踏入了地監地下 ${this.state.player.currentFloor} 層...`); this.setPhase('explore'); },
        showVillageOptions() { this.setOutput('你回到了村莊，這裡感覺安全多了。'); this.renderButtons([{ text: '繼續冒險', action: () => this.enterDungeon() }, { text: '背包', action: () => this.showInventory() }, { text: '休息', action: () => this.restInVillage() }]); },
        showExploreOptions() { this.renderButtons([{ text: '探索', action: () => this.exploreDungeon() }, { text: '背包', action: () => this.showInventory() }, { text: '回村', action: () => this.returnToVillage() }]); },

        exploreDungeon() {
            this.state.player.explorationsOnFloor++;
            if (this.state.player.explorationsOnFloor >= this.CONSTANTS.EXPLORATIONS_PER_FLOOR && this.state.player.currentFloor < this.CONSTANTS.MAX_DUNGEON_FLOOR) {
                this.state.player.currentFloor++;
                this.state.player.explorationsOnFloor = 0;
                this.appendOutput(`你已深入地監，進入了地下 ${this.state.player.currentFloor} 層！`);
            }
            const rand = Math.random();
            if (rand < 0.6) {
                const pool = this.data.floorMonsterPools[this.state.player.currentFloor] || this.data.floorMonsterPools[1];
                const monsterKey = pool[Math.floor(Math.random() * pool.length)];
                const baseMonster = this.data.monsters[monsterKey];
                this.state.currentMonster = { ...baseMonster };
                this.state.currentMonster.hp = Math.round(baseMonster.hp * (1 + (this.state.player.currentFloor - 1) * this.CONSTANTS.MONSTER_HP_SCALING));
                this.state.currentMonster.attack = Math.round(baseMonster.attack * (1 + (this.state.player.currentFloor - 1) * this.CONSTANTS.MONSTER_ATTACK_SCALING));
                this.setOutput(`你遇到了一隻 ${this.state.currentMonster.name} (Lv.${this.state.currentMonster.level}, 地下 ${this.state.player.currentFloor} 層)！`);
                if (this.state.currentMonster.image) {
                    this.DOM.monsterImage.src = this.state.currentMonster.image;
                    this.DOM.monsterImage.style.display = 'block';
                }
                this.playSound('encounter');
                this.setPhase('combat');
            } else if (rand < 0.75) { this.findItem(); this.setPhase('explore'); } 
            else { this.appendOutput('你繼續探索，但什麼也沒發現...'); this.setPhase('explore'); }
            this.updateUI();
        },

        findItem() { /* ... 內容不變 ... */ const possibleItems = Object.keys(this.data.items).filter(k => this.data.items[k].sell); const foundItemKey = possibleItems[Math.floor(Math.random() * possibleItems.length)]; this.state.player.inventory.push(foundItemKey); this.appendOutput(`你找到了一個 ${this.data.items[foundItemKey].name}！`); },
        showCombatOptions() { this.renderButtons([{ text: '攻擊', action: () => this.playerAttack(), className: 'game-button red-button' }, { text: '背包', action: () => this.showInventory() }, { text: '逃跑', action: () => this.runAway() }]); },
        
        playerAttack() {
            if (!this.state.currentMonster) return;
            this.playSound('attack');
            const p = this.state.player;
            const m = this.state.currentMonster;
            const playerStats = this.calculatePlayerStats();
            const playerDamage = Math.max(1, playerStats.attack - Math.floor(m.level / 5));
            m.hp -= playerDamage;
            this.appendOutput(`你對 ${m.name} 造成了 ${playerDamage} 點傷害！ (怪物剩餘HP: ${m.hp > 0 ? m.hp : 0})`);
            if (m.hp <= 0) { this.handleMonsterDefeat(); return; }
            const monsterDamage = Math.max(1, m.attack - playerStats.defense);
            p.hp -= monsterDamage;
            this.appendOutput(`${m.name} 對你造成了 ${monsterDamage} 點傷害！`);
            this.updateStatus();
            if (p.hp <= 0) this.gameOver('你的生命值歸零了。你倒在了地監深處...');
        },

        handleMonsterDefeat() {
            this.playSound('victory');
            const m = this.state.currentMonster;
            this.appendOutput(`${m.name} 被你擊敗了！`);
            const goldEarned = Math.floor(Math.random() * (m.goldMax - m.goldMin + 1)) + m.goldMin;
            this.state.player.gold += goldEarned;
            this.appendOutput(`你獲得了 ${goldEarned} 金幣！`);
            this.state.player.xp += m.xpReward;
            this.appendOutput(`你獲得了 ${m.xpReward} 經驗值！`);
            this.checkLevelUp();
            m.drops?.forEach(drop => { if (Math.random() < drop.chance) { this.state.player.inventory.push(drop.itemKey); this.appendOutput(`你獲得了 ${this.data.items[drop.itemKey].name}！`); } });
            this.state.currentMonster = null;
            this.setPhase('explore');
        },

        runAway() { /* ... 內容不變 ... */ if (Math.random() < 0.5) { this.setOutput('你成功逃跑了！'); this.state.currentMonster = null; this.setPhase('explore'); } else { this.appendOutput('你嘗試逃跑，但失敗了！'); const m = this.state.currentMonster; const playerStats = this.calculatePlayerStats(); const monsterDamage = Math.max(1, m.attack - playerStats.defense); this.state.player.hp -= monsterDamage; this.appendOutput(`${m.name} 對你造成了 ${monsterDamage} 點傷害！`); this.updateStatus(); if (this.state.player.hp <= 0) { this.gameOver('你的生命值歸零了。你倒在了地監深處...'); } } },
        
        checkLevelUp() {
            while (this.state.player.xp >= this.state.player.xpToNextLevel) {
                this.playSound('levelUp');
                this.state.player.level++;
                this.state.player.xp -= this.state.player.xpToNextLevel;
                this.state.player.xpToNextLevel = this.getXpRequiredForLevel(this.state.player.level);
                const hpGain = 10, attackGain = 2, defenseGain = 1;
                this.state.player.maxHp += hpGain;
                this.state.player.baseAttack += attackGain;
                this.state.player.baseDefense += defenseGain;
                this.state.player.hp = this.state.player.maxHp;
                this.appendOutput(`恭喜！你升到了等級 ${this.state.player.level}！\n生命上限+${hpGain}, 基礎攻擊+${attackGain}, 基礎防禦+${defenseGain}。`);
            }
        },

        returnToVillage() { this.state.player.currentFloor = 1; this.state.player.explorationsOnFloor = 0; this.setPhase('village'); },
        restInVillage() { if (this.state.player.hp < this.state.player.maxHp) { this.state.player.hp = this.state.player.maxHp; this.appendOutput(`你在村莊休息，生命值完全恢復了！`); this.updateStatus(); } else { this.appendOutput('你的生命值已經是滿的了。'); } },
        
        gameOver(message) {
            this.playSound('gameOver');
            this.state.gamePhase = 'game_over';
            this.DOM.gameOverMessage.textContent = message;
            this.DOM.gameOverModal.classList.remove('hidden');
            this.renderButtons([]);
            this.updateUI();
        },

        showInventory() { /* ... 內容不變 ... */ this.state.lastMajorPhase = this.state.gamePhase; this.state.gamePhase = 'inventory'; this.DOM.inventoryDisplay.classList.remove('hidden'); this.DOM.inventoryDisplay.innerHTML = `<h3 class="text-xl font-bold mb-2 text-center text-gray-300">背包物品</h3><ul id="inventoryListUl"></ul>`; this.renderInventory(); this.renderButtons([{ text: '返回', action: () => this.closeSubmenu() }]); this.updateUI(); },
        renderInventory() { /* ... 內容不變 ... */ const listUl = this.DOM.inventoryDisplay.querySelector('#inventoryListUl'); listUl.innerHTML = ''; if (this.state.player.inventory.length === 0) { listUl.innerHTML = '<li class="text-center text-gray-400">背包是空的。</li>'; return; } const itemCounts = this.state.player.inventory.reduce((acc, key) => { acc[key] = (acc[key] || 0) + 1; return acc; }, {}); for (const itemKey in itemCounts) { const itemData = this.data.items[itemKey]; const li = document.createElement('li'); let text = `${this.getFormattedItemName(itemKey)} x${itemCounts[itemKey]}`; li.innerHTML = `<span class="item-name">${text}</span>`; const actionsDiv = document.createElement('div'); actionsDiv.className = 'item-actions'; if (itemData.type === 'weapon' || itemData.type === 'armor') { const equipBtn = document.createElement('button'); equipBtn.textContent = '裝備'; equipBtn.className = 'equip-btn'; equipBtn.onclick = () => this.showEquipConfirmation(itemKey); actionsDiv.appendChild(equipBtn); } if (itemData.type === 'potion' || itemData.type === 'scroll') { const useBtn = document.createElement('button'); useBtn.textContent = '使用'; useBtn.className = 'use-btn'; useBtn.onclick = () => this.useItem(itemKey); actionsDiv.appendChild(useBtn); } li.appendChild(actionsDiv); listUl.appendChild(li); } },
        closeSubmenu() { this.setPhase(this.state.lastMajorPhase); },
        showEquipConfirmation(itemKeyToEquip) { /* ... 內容不變 ... */ const itemData = this.data.items[itemKeyToEquip]; const slot = itemData.slot; const currentItemKey = this.state.player.equipped[slot]; const currentItemData = currentItemKey ? this.data.items[currentItemKey] : null; this.DOM.equipModalTitle.textContent = `裝備 ${itemData.name}`; let comparisonHTML = `<div><h3>${currentItemKey ? this.getFormattedItemName(currentItemKey) : '無'} (現有)</h3><p>攻擊: ${currentItemData?.attack || 0}</p><p>防禦: ${currentItemData?.defense || 0}</p></div><div><h3>${this.getFormattedItemName(itemKeyToEquip)} (新)</h3>`; const attackDiff = (itemData.attack || 0) - (currentItemData?.attack || 0); const defenseDiff = (itemData.defense || 0) - (currentItemData?.defense || 0); comparisonHTML += `<p>攻擊: ${itemData.attack || 0} <span class="${attackDiff > 0 ? 'stat-change-gain' : attackDiff < 0 ? 'stat-change-loss' : ''}">(${attackDiff > 0 ? '+' : ''}${attackDiff})</span></p>`; comparisonHTML += `<p>防禦: ${itemData.defense || 0} <span class="${defenseDiff > 0 ? 'stat-change-gain' : defenseDiff < 0 ? 'stat-change-loss' : ''}">(${defenseDiff > 0 ? '+' : ''}${defenseDiff})</span></p></div>`; this.DOM.equipComparison.innerHTML = comparisonHTML; this.DOM.confirmEquipButton.onclick = () => this.equipItem(itemKeyToEquip); this.DOM.equipConfirmModal.classList.remove('hidden'); },
        equipItem(itemKey) { /* ... 內容不變 ... */ const itemData = this.data.items[itemKey]; const slot = itemData.slot; const currentItemKey = this.state.player.equipped[slot]; if (currentItemKey) { this.state.player.inventory.push(currentItemKey); } this.state.player.equipped[slot] = itemKey; const index = this.state.player.inventory.indexOf(itemKey); if (index > -1) this.state.player.inventory.splice(index, 1); this.appendOutput(`你裝備了 ${itemData.name}。`); this.DOM.equipConfirmModal.classList.add('hidden'); this.updateUI(); if (this.state.gamePhase === 'inventory') { this.renderInventory(); } },
        unequipItem(slotKey) { /* ... 內容不變 ... */ const itemKey = this.state.player.equipped[slotKey]; if (itemKey) { this.state.player.inventory.push(itemKey); this.state.player.equipped[slotKey] = null; this.appendOutput(`你卸下了 ${this.data.items[itemKey].name}。`); this.updateUI(); } },
        useItem(itemKey) { /* ... 內容不變 ... */ const itemData = this.data.items[itemKey]; const effect = itemData.effect; if (!effect) return; let used = false; if (effect.type === 'heal') { if (this.state.player.hp < this.state.player.maxHp) { this.state.player.hp = Math.min(this.state.player.maxHp, this.state.player.hp + effect.amount); this.appendOutput(`你使用了 ${itemData.name}，恢復了 ${effect.amount} 點生命值！`); used = true; } else { this.appendOutput('你的生命值已滿。'); } } else if (effect.type === 'teleportHome') { this.appendOutput(`你使用了 ${itemData.name}，一道光芒將你傳送回村莊。`); this.returnToVillage(); used = true; } if (used) { const index = this.state.player.inventory.indexOf(itemKey); if (index > -1) this.state.player.inventory.splice(index, 1); this.updateUI(); if(this.state.gamePhase === 'inventory') this.renderInventory(); } },
        
        playSound(soundName) {
            const soundSrc = this.data.soundMap[soundName];
            if (!soundSrc) return;
            const audio = this.AssetLoader.loadedAssets.get(soundSrc);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(error => console.error(`無法播放音訊 ${soundName}:`, error));
            }
        },
        
        getFormattedItemName(itemKey) { /* ... 內容不變 ... */ const itemData = this.data.items[itemKey]; if (!itemData) return ''; const rarity = itemData.rarity || 'common'; const colorClass = { common: 'text-gray-300', uncommon: 'text-green-400', rare: 'text-blue-400' }[rarity]; return `<span class="${colorClass}">${itemData.name}</span>`; },
        calculatePlayerStats() { /* ... 內容不變 ... */ const p = this.state.player; let totalAttack = p.baseAttack; let totalDefense = p.baseDefense; for (const slot in p.equipped) { const itemKey = p.equipped[slot]; if (itemKey && this.data.items[itemKey]) { const itemData = this.data.items[itemKey]; totalAttack += itemData.attack || 0; totalDefense += itemData.defense || 0; } } return { attack: totalAttack, defense: totalDefense }; },
        getXpRequiredForLevel(level) { return Math.floor(100 + (level - 1) * 50); },
        appendOutput(message) { this.DOM.gameOutput.textContent += '\n' + message; this.DOM.gameOutput.scrollTop = this.DOM.gameOutput.scrollHeight; },
        setOutput(message) { this.DOM.gameOutput.textContent = message; },
    };

    window.onload = () => {
        try {
            Game.init();
        } catch (error) {
            console.error("遊戲初始化失敗:", error);
            document.body.innerHTML = `<div style="color: red; text-align: center; margin-top: 50px; font-size: 1.5rem;">遊戲載入失敗：${error.message}</div>`;
        }
    };
    </script>
</body>
</html>
