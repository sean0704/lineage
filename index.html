<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地監冒險 (優化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        .game-container {
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 100%;
            padding: 1.5rem;
            border: 2px solid #4a5568;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; 
        }
        .header h1 {
            font-size: 2rem; 
            font-weight: 700;
            color: #a0aec0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        .status-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* MODIFIED: Centered the single item */
            background-color: #4a5568;
            padding: 0.25rem; /* MODIFIED: Reduced padding */
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #cbd5e0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid #5a6478;
        }
        .status-bar span {
            margin: 0.25rem 0.5rem;
            padding: 0.2rem 0.4rem;
            border-radius: 0.3rem;
            background-color: #3a4352;
        }
        .game-output {
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 1rem;
            height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 1rem;
            line-height: 1.5;
            color: #e2e8f0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }
        .game-button {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            flex-grow: 1;
            min-width: 120px;
        }
        .game-button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
        }
        .game-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .red-button { background-color: #e53e3e; }
        .red-button:hover { background-color: #c53030; }
        .green-button { background-color: #48bb78; }
        .green-button:hover { background-color: #38a169; }
        .gray-button { background-color: #718096; }
        .gray-button:hover { background-color: #4a5568; }

        .list-container {
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 1rem;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-top: 1rem;
        }
        .list-container ul { list-style: none; padding: 0; margin: 0; }
        .list-container li {
            padding: 0.5rem;
            border-bottom: 1px dashed #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .list-container li:hover { background-color: #3a4352; border-radius: 0.5rem; }
        .list-container li:last-child { border-bottom: none; }
        .list-container li .item-name { flex-grow: 1; }
        .list-container li .item-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .list-container li button {
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .equip-btn { background-color: #63b3ed; }
        .equip-btn:hover { background-color: #4299e1; }
        .use-btn { background-color: #a0aec0; }
        .use-btn:hover { background-color: #718096; }
        .buy-btn { background-color: #48bb78; }
        .buy-btn:hover { background-color: #38a169; }
        .sell-btn { background-color: #f56565; }
        .sell-btn:hover { background-color: #e53e3e; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: #2d3748; padding: 2rem; border-radius: 1.0rem;
            text-align: center; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            border: 2px solid #4a5568; max-width: 90%; width: 500px;
        }
        .modal-content h2 { font-size: 2rem; color: #a0aec0; margin-bottom: 1rem; }
        .modal-content p { font-size: 1.2rem; margin-bottom: 1.5rem; }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: left; margin-bottom: 1.5rem; }
        .comparison-grid h3 { font-weight: bold; color: #718096; border-bottom: 1px solid #4a5568; padding-bottom: 0.5rem; }
        .stat-change-loss { color: #f56565; }
        .stat-change-gain { color: #48bb78; }

        .health-bar-wrapper {
            width: 100%; margin: 0.5rem 0; background-color: #3a4352;
            border-radius: 0.75rem; padding: 0.5rem; position: relative;
            height: 2.5rem; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .health-bar-container {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            background-color: #555; border-radius: 0.5rem; overflow: hidden;
        }
        .health-bar-fill {
            height: 100%; background: linear-gradient(to right, #e53e3e, #c53030);
            width: 100%; transition: width 0.5s ease-in-out; border-radius: 0.5rem;
        }
        .health-bar-text {
            position: absolute; color: white; font-weight: bold; text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>
    <div id="gameContainer" class="game-container">
        <div class="header text-center mb-1"> 
            <h2>地監冒險</h2>
        </div>

        <!-- MODIFIED: Simplified the status bar -->
        <div class="status-bar">
            <div class="health-bar-wrapper">
                <div id="playerHealthBarContainer" class="health-bar-container">
                    <div id="playerHealthBarFill" class="health-bar-fill"></div>
                </div>
                <div id="playerHealthText" class="health-bar-text"></div>
            </div>
        </div>

        <div id="featureBar" class="flex justify-around p-2 rounded-lg bg-gray-700 mt-4 gap-2">
            <button id="featureBtnInventory" class="game-button">背包</button>
            <button id="featureBtnReturnToVillage" class="game-button">回村</button>
        </div>

        <div id="equippedItemsDisplay" class="list-container">
            <h3 class="text-xl font-bold mb-2 text-center text-gray-300">
                已裝備物品
                <button id="toggleEquippedButton" class="text-sm px-2 py-1 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors ml-2">展開</button>
            </h3>
            <div id="equippedListContainer" class="hidden">
                <ul id="equippedList"></ul>
            </div>
        </div>

        <div id="gameOutput" class="game-output"></div>
        <div id="buttonGroup" class="button-group"></div>
        <div id="inventoryDisplay" class="list-container hidden"></div>
        <div id="shopDisplay" class="list-container hidden"></div>
    </div>

    <!-- Modals -->
    <div id="gameOverModal" class="modal hidden">
        <div class="modal-content">
            <h2>遊戲結束！</h2>
            <p id="gameOverMessage"></p>
            <button id="restartButton" class="game-button green-button">重新開始</button>
        </div>
    </div>
    <div id="equipConfirmModal" class="modal hidden">
        <div class="modal-content">
            <h2 id="equipModalTitle">確認裝備</h2>
            <div id="equipComparison" class="comparison-grid"></div>
            <div class="flex justify-center gap-4">
                <button id="confirmEquipButton" class="game-button green-button">確認</button>
                <button id="cancelEquipButton" class="game-button gray-button">取消</button>
            </div>
        </div>
    </div>

    <script>
    const Game = {
        // --- 1. DOM Elements & Constants ---
        DOM: {},
        CONSTANTS: {
            SAVE_KEY: 'dungeonAdventureSaveData',
            MAX_DUNGEON_FLOOR: 7,
            EXPLORATIONS_PER_FLOOR: 10,
            MONSTER_HP_SCALING: 0.2,
            MONSTER_ATTACK_SCALING: 0.1,
        },

        // --- 2. Game State ---
        state: {
            player: null,
            currentMonster: null,
            gamePhase: 'start',
            lastNonInventoryPhase: 'start',
        },

        // --- 3. Game Data ---
        data: {
            monsters: {},
            items: {},
            floorMonsterPools: {},
        },

        // --- 4. Core Methods ---
        init() {
            this.cacheDOMElements();
            this.loadData();
            this.bindEvents();
            if (!this.loadGame()) {
                this.resetGame();
            }
        },

        cacheDOMElements() {
            // MODIFIED: Removed IDs for stats that are no longer displayed in the status bar
            const ids = [
                'playerHealthBarFill', 'playerHealthText', 'equippedList',
                'gameOutput', 'buttonGroup', 'inventoryDisplay', 'shopDisplay', 'gameOverModal',
                'gameOverMessage', 'restartButton', 'toggleEquippedButton', 'equippedListContainer',
                'featureBtnInventory', 'featureBtnReturnToVillage', 'equipConfirmModal', 'equipModalTitle',
                'equipComparison', 'confirmEquipButton', 'cancelEquipButton'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) throw new Error(`Critical DOM element not found: #${id}`);
                this.DOM[id] = el;
            });
        },
        
        loadData() {
            this.data.items = {
                'dagger': { name: '匕首', type: 'weapon', slot: 'rightHand', buy: 150, sell: 55, attack: 3, defense: 0 },
                'shortBow': { name: '短弓', type: 'weapon', slot: 'rightHand', buy: 120, sell: 50, attack: 4, defense: 0 },
                'longSword': { name: '長劍', type: 'weapon', slot: 'rightHand', sell: 1500, attack: 7, defense: 0 },
                'greatAxe': { name: '巨斧', type: 'weapon', slot: 'rightHand', sell: 385, attack: 5, defense: 0 },
                'mithrilDagger': { name: '米索莉短劍', type: 'weapon', slot: 'rightHand', sell: 2500, attack: 5, defense: 0 },
                'twoHandedSword': { name: '雙手劍', type: 'weapon', slot: 'rightHand', sell: 9000, attack: 12, defense: 0 },
                'wizardStaff': { name: '巫杖', type: 'weapon', slot: 'rightHand', sell: 4500, attack: 8, defense: 0 },
                'leatherArmor': { name: '皮甲', type: 'armor', slot: 'body', buy: 800, sell: 400, defense: 2 },
                'vineArmor': { name: '藤甲', type: 'armor', slot: 'body', sell: 1000, defense: 3 },
                'scaleMail': { name: '鱗甲', type: 'armor', slot: 'body', sell: 4000, defense: 4 },
                'ironArmor': { name: '鐵盔甲', type: 'armor', slot: 'body', sell: 15000, defense: 6 },
                'leatherHelm': { name: '皮盔甲', type: 'armor', slot: 'head', buy: 400, sell: 150, defense: 1 },
                'ironHelm': { name: '鐵頭盔', type: 'armor', slot: 'head', buy: 750, sell: 300, defense: 2 },
                'mageHat': { name: '法師帽', type: 'armor', slot: 'head', buy: 250, sell: 100, defense: 1 },
                'elvenShield': { name: '精靈盾牌', type: 'armor', slot: 'leftHand', sell: 2000, defense: 2 },
                'woodenShield': { name: '木盾', type: 'armor', slot: 'leftHand', buy: 80, sell: 30, defense: 1 },
                'redPotion': { name: '紅色藥水', type: 'potion', buy: 50, sell: 20, effect: { type: 'heal', amount: 30 } },
                'greenPotion': { name: '綠色藥水', type: 'potion', buy: 200, sell: 100, effect: { type: 'heal', amount: 50 } },
                'bravePotion': { name: '勇敢藥水', type: 'potion', buy: 800, sell: 400, effect: { type: 'heal', amount: 75 } },
                'elvenWafer': { name: '精靈餅乾', type: 'potion', buy: 150, sell: 50, effect: { type: 'heal', amount: 40 } },
                'teleportHomeScroll': { name: '傳送回家的卷軸', type: 'scroll', buy: 250, sell: 100, effect: { type: 'teleportHome' } },
            };
            this.data.monsters = {
                'goblin': { name: '妖魔', level: 20, hp: 80, attack: 16, goldMin: 200, goldMax: 400, xpReward: 100, drops: [{ itemKey: 'redPotion', chance: 0.3 }] },
                'goblinArcher': { name: '妖魔弓箭手', level: 22, hp: 88, attack: 18, goldMin: 220, goldMax: 440, xpReward: 110, drops: [{ itemKey: 'shortBow', chance: 0.1 }] },
                'goblinFighter': { name: '妖魔鬥士', level: 24, hp: 96, attack: 19, goldMin: 240, goldMax: 480, xpReward: 120, drops: [{ itemKey: 'greatAxe', chance: 0.1 }] },
                'skeleton': { name: '骷髏', level: 20, hp: 80, attack: 16, goldMin: 200, goldMax: 400, xpReward: 100, drops: [] },
                'skeletonArcher': { name: '骷髏弓箭手', level: 22, hp: 88, attack: 18, goldMin: 220, goldMax: 440, xpReward: 110, drops: [{ itemKey: 'shortBow', chance: 0.1 }] },
                'zombie': { name: '人形殭屍', level: 20, hp: 80, attack: 16, goldMin: 200, goldMax: 400, xpReward: 100, drops: [{ itemKey: 'redPotion', chance: 0.3 }] },
                'sparto': { name: '史巴托', level: 25, hp: 100, attack: 20, goldMin: 250, goldMax: 500, xpReward: 125, drops: [{ itemKey: 'leatherArmor', chance: 0.1 }] },
                'skeletonAxeman': { name: '骷髏斧手', level: 24, hp: 96, attack: 19, goldMin: 240, goldMax: 480, xpReward: 120, drops: [{ itemKey: 'greatAxe', chance: 0.1 }] },
                'skeletonSpearman': { name: '骷髏槍兵', level: 25, hp: 100, attack: 20, goldMin: 250, goldMax: 500, xpReward: 125, drops: [{ itemKey: 'longSword', chance: 0.1 }] },
                'shelob': { name: '夏洛伯', level: 28, hp: 112, attack: 22, goldMin: 280, goldMax: 560, xpReward: 140, drops: [{ itemKey: 'greenPotion', chance: 0.3 }] },
                'ghoul': { name: '食屍鬼', level: 30, hp: 120, attack: 24, goldMin: 300, goldMax: 600, xpReward: 150, drops: [{ itemKey: 'leatherHelm', chance: 0.1 }] },
                'ungoliant': { name: '楊果里恩', level: 30, hp: 120, attack: 24, goldMin: 300, goldMax: 600, xpReward: 150, drops: [] },
                'ogre': { name: '食人妖精', level: 32, hp: 128, attack: 25, goldMin: 320, goldMax: 640, xpReward: 160, drops: [{ itemKey: 'greatAxe', chance: 0.1 }, { itemKey: 'vineArmor', chance: 0.1 }, { itemKey: 'greenPotion', chance: 0.4 }] },
                'stoneGolem': { name: '石頭高崙', level: 35, hp: 140, attack: 28, goldMin: 350, goldMax: 700, xpReward: 175, drops: [] },
                'cerberus': { name: '地獄犬', level: 36, hp: 144, attack: 29, goldMin: 360, goldMax: 720, xpReward: 180, drops: [{ itemKey: 'wizardStaff', chance: 0.05 }, { itemKey: 'redPotion', chance: 0.5 }] },
                'floatingEye': { name: '漂浮之眼', level: 42, hp: 168, attack: 34, goldMin: 420, goldMax: 840, xpReward: 210, drops: [] },
                'ogreKing': { name: '食人妖精王', level: 40, hp: 160, attack: 32, goldMin: 400, goldMax: 800, xpReward: 200, drops: [{ itemKey: 'ironArmor', chance: 0.05 }, { itemKey: 'bravePotion', chance: 0.1 }] },
                'deathKnight': { name: '死亡騎士', level: 85, hp: 850, attack: 85, goldMin: 8000, goldMax: 20000, xpReward: 1000, drops: [{ itemKey: 'twoHandedSword', chance: 0.2 }, { itemKey: 'ironArmor', chance: 0.15 }, { itemKey: 'bravePotion', chance: 0.5 }] },
                'casper': { name: '卡士伯', level: 44, hp: 440, attack: 44, goldMin: 2700, goldMax: 8500, xpReward: 550, drops: [{ itemKey: 'elvenShield', chance: 0.2 }, { itemKey: 'mageHat', chance: 0.15 }, { itemKey: 'greenPotion', chance: 0.5 }] },
                'markus': { name: '馬庫爾', level: 45, hp: 450, attack: 45, goldMin: 2800, goldMax: 9000, xpReward: 575, drops: [{ itemKey: 'mithrilDagger', chance: 0.25 }, { itemKey: 'scaleMail', chance: 0.2 }] },
            };
            this.data.floorMonsterPools = {
                1: ['goblin', 'goblinArcher', 'goblinFighter', 'skeleton', 'skeletonArcher', 'zombie', 'sparto'],
                2: ['zombie', 'skeletonAxeman', 'skeletonArcher', 'skeletonSpearman', 'sparto', 'shelob', 'ghoul', 'ungoliant', 'ogre'],
                3: ['zombie', 'skeletonAxeman', 'skeletonArcher', 'skeletonSpearman', 'sparto', 'shelob', 'ghoul', 'ungoliant', 'ogre', 'stoneGolem'],
                4: ['zombie', 'skeletonAxeman', 'skeletonArcher', 'skeletonSpearman', 'sparto', 'shelob', 'ghoul', 'ungoliant', 'ogre', 'stoneGolem', 'cerberus'],
                5: ['shelob', 'skeletonArcher', 'skeletonSpearman', 'ungoliant', 'ghoul', 'ogre', 'cerberus'],
                6: ['floatingEye', 'sparto', 'ghoul', 'ogre', 'ogreKing', 'cerberus'],
                7: ['ogre', 'ogreKing', 'ghoul', 'ungoliant', 'cerberus']
            };
        },

        bindEvents() {
            this.DOM.restartButton.addEventListener('click', () => this.resetGame());
            this.DOM.toggleEquippedButton.addEventListener('click', () => this.toggleEquippedDisplay());
            this.DOM.featureBtnInventory.addEventListener('click', () => this.showInventory());
            this.DOM.featureBtnReturnToVillage.addEventListener('click', () => this.returnToVillage());
            this.DOM.cancelEquipButton.addEventListener('click', () => this.DOM.equipConfirmModal.classList.add('hidden'));
        },

        // --- 5. Game State Management ---
        saveGame() {
            try {
                localStorage.setItem(this.CONSTANTS.SAVE_KEY, JSON.stringify(this.state.player));
                this.appendOutput('遊戲進度已儲存！');
            } catch (e) {
                console.error("無法儲存遊戲:", e);
                this.appendOutput('錯誤：無法儲存遊戲。可能是瀏覽器設定問題。');
            }
        },

        loadGame() {
            try {
                const savedData = localStorage.getItem(this.CONSTANTS.SAVE_KEY);
                if (savedData) {
                    this.state.player = JSON.parse(savedData);
                    this.appendOutput('已讀取先前的遊戲進度。歡迎回來！');
                    this.setPhase('village');
                    return true;
                }
                return false;
            } catch (e) {
                console.error("無法讀取存檔:", e);
                this.appendOutput('讀取存檔失敗，將開始新遊戲。');
                return false;
            }
        },

        deleteSave() {
            localStorage.removeItem(this.CONSTANTS.SAVE_KEY);
            this.appendOutput('存檔已刪除。');
            this.resetGame();
        },
        
        resetGame() {
            this.state.player = this.getInitialPlayerState();
            this.state.currentMonster = null;
            this.DOM.gameOverModal.classList.add('hidden');
            this.setOutput('你已在木人場訓練有成！準備好進入地監冒險了嗎?');
            this.setPhase('start');
        },

        getInitialPlayerState() {
            const level = 5;
            const maxHp = 100 + (level - 1) * 10;
            return {
                hp: maxHp, maxHp: maxHp, gold: 500,
                baseAttack: 10 + (level - 1) * 2,
                baseDefense: 0 + (level - 1) * 1,
                level: level, xp: 0,
                xpToNextLevel: this.getXpRequiredForLevel(level),
                inventory: [],
                equipped: { head: null, body: null, legs: null, rightHand: null, leftHand: null },
                currentFloor: 1, explorationsOnFloor: 0,
            };
        },

        // --- 6. UI Update & Rendering ---
        updateUI() {
            this.updateStatus();
            this.updateFeatureBar();
        },

        updateStatus() {
            const p = this.state.player;
            const stats = this.calculatePlayerStats();

            const hpPercentage = (p.hp / p.maxHp) * 100;
            this.DOM.playerHealthBarFill.style.width = `${hpPercentage}%`;
            this.DOM.playerHealthText.textContent = `${p.hp} / ${p.maxHp}`;
            
            // The following elements are removed, so we don't update them.
            // this.DOM.playerGold.textContent = p.gold;
            // this.DOM.playerAttack.textContent = stats.attack;
            // this.DOM.playerDefense.textContent = stats.defense;
            // this.DOM.playerLevel.textContent = p.level;
            // this.DOM.playerXP.textContent = p.xp;
            // this.DOM.playerXPToNextLevel.textContent = p.xpToNextLevel;
            // this.DOM.currentFloor.textContent = p.currentFloor;

            this.renderEquippedItems();
        },
        
        renderButtons(buttonArray) {
            this.DOM.buttonGroup.innerHTML = '';
            buttonArray.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                button.className = btn.className || 'game-button';
                button.onclick = btn.action;
                button.disabled = btn.disabled || false;
                this.DOM.buttonGroup.appendChild(button);
            });
        },

        renderEquippedItems() {
            this.DOM.equippedList.innerHTML = '';
            const slotOrder = { head: '頭部', body: '身體', legs: '腿部', rightHand: '右手', leftHand: '左手' };
            for(const slotKey in slotOrder) {
                const li = document.createElement('li');
                const itemKey = this.state.player.equipped[slotKey];
                let text = `${slotOrder[slotKey]}: `;
                if (itemKey) {
                    const itemData = this.data.items[itemKey];
                    text += itemData.name;
                    const unequipBtn = document.createElement('button');
                    unequipBtn.textContent = '卸下';
                    unequipBtn.className = 'equip-btn';
                    unequipBtn.onclick = () => this.unequipItem(slotKey);
                    li.innerHTML = `<span class="item-name">${text}</span>`;
                    li.appendChild(unequipBtn);
                } else {
                    text += '無';
                    li.innerHTML = `<span class="item-name">${text}</span>`;
                }
                this.DOM.equippedList.appendChild(li);
            }
        },

        updateFeatureBar() {
            const phase = this.state.gamePhase;
            this.DOM.featureBtnInventory.disabled = (phase === 'game_over');
            this.DOM.featureBtnReturnToVillage.disabled = (phase === 'village' || phase === 'start' || phase === 'game_over' || phase === 'combat');
        },

        toggleEquippedDisplay() {
            const isHidden = this.DOM.equippedListContainer.classList.toggle('hidden');
            this.DOM.toggleEquippedButton.textContent = isHidden ? '展開' : '收合';
        },

        // --- 7. Game Logic & Phases ---
        setPhase(newPhase) {
            this.state.gamePhase = newPhase;
            this.DOM.inventoryDisplay.classList.add('hidden');
            this.DOM.shopDisplay.classList.add('hidden');

            switch (newPhase) {
                case 'start': this.showStartOptions(); break;
                case 'village': this.showVillageOptions(); break;
                case 'explore': this.showExploreOptions(); break;
                case 'combat': this.showCombatOptions(); break;
            }
            this.updateUI();
        },
        
        showStartOptions() {
            this.renderButtons([{ text: '進入地監', action: () => this.enterDungeon() }]);
        },

        enterDungeon() {
            this.setOutput(`你踏入了地監地下 ${this.state.player.currentFloor} 層... 周圍一片漆黑，你感覺到危險潛伏著。`);
            this.setPhase('explore');
        },

        showVillageOptions() {
            this.setOutput('你回到了村莊，這裡感覺安全多了。');
            this.renderButtons([
                { text: '休息 (回滿血)', action: () => this.restInVillage() },
                { text: '商店', action: () => this.showShop() },
                { text: '繼續冒險', action: () => this.enterDungeon() },
                { text: '儲存遊戲', action: () => this.saveGame(), className: 'game-button gray-button' },
                { text: '刪除存檔', action: () => this.deleteSave(), className: 'game-button red-button' },
            ]);
        },

        showExploreOptions() {
            this.renderButtons([{ text: '探索', action: () => this.exploreDungeon() }]);
        },

        exploreDungeon() {
            this.state.player.explorationsOnFloor++;
            if (this.state.player.explorationsOnFloor >= this.CONSTANTS.EXPLORATIONS_PER_FLOOR && this.state.player.currentFloor < this.CONSTANTS.MAX_DUNGEON_FLOOR) {
                this.state.player.currentFloor++;
                this.state.player.explorationsOnFloor = 0;
                this.appendOutput(`你已深入地監，進入了地下 ${this.state.player.currentFloor} 層！`);
            }

            const rand = Math.random();
            if (rand < 0.6) { // 60% chance for monster
                const pool = this.data.floorMonsterPools[this.state.player.currentFloor] || this.data.floorMonsterPools[1];
                const monsterKey = pool[Math.floor(Math.random() * pool.length)];
                const baseMonster = this.data.monsters[monsterKey];
                
                this.state.currentMonster = { ...baseMonster }; // Create a copy
                this.state.currentMonster.hp = Math.round(baseMonster.hp * (1 + (this.state.player.currentFloor - 1) * this.CONSTANTS.MONSTER_HP_SCALING));
                this.state.currentMonster.attack = Math.round(baseMonster.attack * (1 + (this.state.player.currentFloor - 1) * this.CONSTANTS.MONSTER_ATTACK_SCALING));

                this.setOutput(`你遇到了一隻 ${this.state.currentMonster.name} (Lv.${this.state.currentMonster.level}, 地下 ${this.state.player.currentFloor} 層)！`);
                this.setPhase('combat');
            } else if (rand < 0.75) { // 15% chance for item
                this.findItem();
                this.setPhase('explore');
            } else { // 25% chance for nothing
                this.appendOutput('你繼續探索，但什麼也沒發現...');
                this.setPhase('explore');
            }
            this.updateUI();
        },

        findItem() {
            const possibleItems = Object.keys(this.data.items).filter(k => this.data.items[k].sell); // Find items that can be sold (i.e., findable)
            const foundItemKey = possibleItems[Math.floor(Math.random() * possibleItems.length)];
            this.state.player.inventory.push(foundItemKey);
            this.appendOutput(`你找到了一個 ${this.data.items[foundItemKey].name}！`);
        },

        showCombatOptions() {
            this.renderButtons([
                { text: '攻擊', action: () => this.playerAttack(), className: 'game-button red-button' },
                { text: '逃跑', action: () => this.runAway() },
                { text: '背包 (戰鬥中)', action: () => this.showInventory('combat') },
            ]);
        },

        playerAttack() {
            if (!this.state.currentMonster) return;
            const p = this.state.player;
            const m = this.state.currentMonster;
            const playerStats = this.calculatePlayerStats();

            const playerDamage = Math.max(1, playerStats.attack - Math.floor(m.level / 5)); // Simple damage formula
            m.hp -= playerDamage;
            this.appendOutput(`你對 ${m.name} 造成了 ${playerDamage} 點傷害！ (怪物剩餘HP: ${m.hp > 0 ? m.hp : 0})`);

            if (m.hp <= 0) {
                this.handleMonsterDefeat();
                return;
            }

            const monsterDamage = Math.max(1, m.attack - playerStats.defense);
            p.hp -= monsterDamage;
            this.appendOutput(`${m.name} 對你造成了 ${monsterDamage} 點傷害！`);
            
            this.updateStatus();
            if (p.hp <= 0) {
                this.gameOver('你的生命值歸零了。你倒在了地監深處...');
            }
        },

        handleMonsterDefeat() {
            const m = this.state.currentMonster;
            this.appendOutput(`${m.name} 被你擊敗了！`);
            
            const goldEarned = Math.floor(Math.random() * (m.goldMax - m.goldMin + 1)) + m.goldMin;
            this.state.player.gold += goldEarned;
            this.appendOutput(`你獲得了 ${goldEarned} 金幣！`);

            this.state.player.xp += m.xpReward;
            this.appendOutput(`你獲得了 ${m.xpReward} 經驗值！`);
            this.checkLevelUp();

            m.drops?.forEach(drop => {
                if (Math.random() < drop.chance) {
                    this.state.player.inventory.push(drop.itemKey);
                    this.appendOutput(`你獲得了 ${this.data.items[drop.itemKey].name}！`);
                }
            });

            this.state.currentMonster = null;
            this.setPhase('explore');
        },

        runAway() {
            if (Math.random() < 0.5) {
                this.setOutput('你成功逃跑了！');
                this.state.currentMonster = null;
                this.setPhase('explore');
            } else {
                this.appendOutput('你嘗試逃跑，但失敗了！');
                const m = this.state.currentMonster;
                const playerStats = this.calculatePlayerStats();
                const monsterDamage = Math.max(1, m.attack - playerStats.defense);
                this.state.player.hp -= monsterDamage;
                this.appendOutput(`${m.name} 對你造成了 ${monsterDamage} 點傷害！`);
                this.updateStatus();
                if (this.state.player.hp <= 0) {
                    this.gameOver('你的生命值歸零了。你倒在了地監深處...');
                }
            }
        },

        checkLevelUp() {
            while (this.state.player.xp >= this.state.player.xpToNextLevel) {
                this.state.player.level++;
                this.state.player.xp -= this.state.player.xpToNextLevel;
                this.state.player.xpToNextLevel = this.getXpRequiredForLevel(this.state.player.level);
                
                const hpGain = 10;
                const attackGain = 2;
                const defenseGain = 1;

                this.state.player.maxHp += hpGain;
                this.state.player.baseAttack += attackGain;
                this.state.player.baseDefense += defenseGain;
                this.state.player.hp = this.state.player.maxHp; // Full heal

                this.appendOutput(`恭喜！你升到了等級 ${this.state.player.level}！\n生命上限+${hpGain}, 基礎攻擊+${attackGain}, 基礎防禦+${defenseGain}。`);
            }
        },

        returnToVillage() {
            this.state.player.currentFloor = 1;
            this.state.player.explorationsOnFloor = 0;
            this.setPhase('village');
        },

        restInVillage() {
            const healAmount = this.state.player.maxHp - this.state.player.hp;
            if (healAmount > 0) {
                this.state.player.hp = this.state.player.maxHp;
                this.appendOutput(`你在村莊休息，生命值完全恢復了！`);
                this.updateStatus();
            } else {
                this.appendOutput('你的生命值已經是滿的了。');
            }
        },
        
        gameOver(message) {
            this.state.gamePhase = 'game_over';
            this.DOM.gameOverMessage.textContent = message;
            this.DOM.gameOverModal.classList.remove('hidden');
            this.renderButtons([]);
            this.updateFeatureBar();
        },

        // --- 8. Inventory, Shop, Items ---
        showInventory(context) {
            // If context is provided (e.g., 'combat'), use it. 
            // Otherwise, save the current phase before switching.
            this.state.lastNonInventoryPhase = context || this.state.gamePhase;
            this.state.gamePhase = 'inventory';

            this.DOM.shopDisplay.classList.add('hidden');
            this.DOM.inventoryDisplay.classList.remove('hidden');
            this.DOM.inventoryDisplay.innerHTML = `<h3 class="text-xl font-bold mb-2 text-center text-gray-300">背包物品</h3><ul id="inventoryListUl"></ul>`;
            
            this.renderInventory();
            this.renderButtons([{ text: '返回', action: () => this.closeSubmenu() }]);
            this.updateFeatureBar();
        },

        renderInventory() {
            const listUl = this.DOM.inventoryDisplay.querySelector('#inventoryListUl');
            listUl.innerHTML = '';
            if (this.state.player.inventory.length === 0) {
                listUl.innerHTML = '<li class="text-center text-gray-400">背包是空的。</li>';
                return;
            }

            const itemCounts = this.state.player.inventory.reduce((acc, key) => {
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            for (const itemKey in itemCounts) {
                const itemData = this.data.items[itemKey];
                const li = document.createElement('li');
                let text = `${itemData.name} x${itemCounts[itemKey]}`;
                li.innerHTML = `<span class="item-name">${text}</span>`;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'item-actions';

                if (itemData.type === 'weapon' || itemData.type === 'armor') {
                    const equipBtn = document.createElement('button');
                    equipBtn.textContent = '裝備';
                    equipBtn.className = 'equip-btn';
                    equipBtn.onclick = () => this.showEquipConfirmation(itemKey);
                    actionsDiv.appendChild(equipBtn);
                }
                if (itemData.type === 'potion' || itemData.type === 'scroll') {
                    const useBtn = document.createElement('button');
                    useBtn.textContent = '使用';
                    useBtn.className = 'use-btn';
                    useBtn.onclick = () => this.useItem(itemKey);
                    actionsDiv.appendChild(useBtn);
                }
                li.appendChild(actionsDiv);
                listUl.appendChild(li);
            }
        },

        showShop() {
            this.state.gamePhase = 'shop';
            this.setOutput('歡迎來到商店！');
            this.DOM.shopDisplay.classList.remove('hidden');
            this.DOM.shopDisplay.innerHTML = `<h3 class="text-xl font-bold mb-2 text-center text-gray-300">商店 / 販賣</h3><ul id="shopListUl"></ul>`;
            this.renderShop();
            this.renderButtons([{ text: '離開商店', action: () => this.setPhase('village') }]);
            this.updateFeatureBar();
        },

        renderShop() {
            const listUl = this.DOM.shopDisplay.querySelector('#shopListUl');
            listUl.innerHTML = '';
            
            // Shop items for buying
            for (const itemKey in this.data.items) {
                const itemData = this.data.items[itemKey];
                if (!itemData.buy) continue;
                const li = document.createElement('li');
                li.innerHTML = `<span class="item-name">${itemData.name} (價格: ${itemData.buy})</span>`;
                const buyBtn = document.createElement('button');
                buyBtn.textContent = '購買';
                buyBtn.className = 'buy-btn';
                buyBtn.onclick = () => this.buyItem(itemKey);
                li.appendChild(buyBtn);
                listUl.appendChild(li);
            }
            listUl.innerHTML += `<li class="text-center font-bold text-gray-500">- - - - - - - 販賣物品 - - - - - - -</li>`;
            // Player items for selling
            const itemCounts = this.state.player.inventory.reduce((acc, key) => { acc[key] = (acc[key] || 0) + 1; return acc; }, {});
            if (Object.keys(itemCounts).length === 0) {
                 listUl.innerHTML += '<li class="text-center text-gray-400">背包是空的。</li>';
            }
            for (const itemKey in itemCounts) {
                const itemData = this.data.items[itemKey];
                if (!itemData.sell) continue;
                const li = document.createElement('li');
                li.innerHTML = `<span class="item-name">${itemData.name} x${itemCounts[itemKey]} (售價: ${itemData.sell})</span>`;
                const sellBtn = document.createElement('button');
                sellBtn.textContent = '販賣';
                sellBtn.className = 'sell-btn';
                sellBtn.onclick = () => this.sellItem(itemKey);
                li.appendChild(sellBtn);
                listUl.appendChild(li);
            }
        },

        closeSubmenu() {
            this.setPhase(this.state.lastNonInventoryPhase);
        },

        showEquipConfirmation(itemKeyToEquip) {
            const itemData = this.data.items[itemKeyToEquip];
            const slot = itemData.slot;
            const currentItemKey = this.state.player.equipped[slot];
            const currentItemData = currentItemKey ? this.data.items[currentItemKey] : null;

            this.DOM.equipModalTitle.textContent = `裝備 ${itemData.name}`;

            let comparisonHTML = `
                <div>
                    <h3>${currentItemData ? currentItemData.name : '無'} (現有)</h3>
                    <p>攻擊: ${currentItemData?.attack || 0}</p>
                    <p>防禦: ${currentItemData?.defense || 0}</p>
                </div>
                <div>
                    <h3>${itemData.name} (新)</h3>
            `;
            const attackDiff = (itemData.attack || 0) - (currentItemData?.attack || 0);
            const defenseDiff = (itemData.defense || 0) - (currentItemData?.defense || 0);
            
            comparisonHTML += `<p>攻擊: ${itemData.attack || 0} <span class="${attackDiff > 0 ? 'stat-change-gain' : attackDiff < 0 ? 'stat-change-loss' : ''}">(${attackDiff > 0 ? '+' : ''}${attackDiff})</span></p>`;
            comparisonHTML += `<p>防禦: ${itemData.defense || 0} <span class="${defenseDiff > 0 ? 'stat-change-gain' : defenseDiff < 0 ? 'stat-change-loss' : ''}">(${defenseDiff > 0 ? '+' : ''}${defenseDiff})</span></p>`;
            comparisonHTML += `</div>`;
            
            this.DOM.equipComparison.innerHTML = comparisonHTML;
            this.DOM.confirmEquipButton.onclick = () => this.equipItem(itemKeyToEquip);
            this.DOM.equipConfirmModal.classList.remove('hidden');
        },

        equipItem(itemKey) {
            const itemData = this.data.items[itemKey];
            const slot = itemData.slot;
            const currentItemKey = this.state.player.equipped[slot];

            // Put current item back to inventory
            if (currentItemKey) {
                this.state.player.inventory.push(currentItemKey);
            }

            // Equip new item and remove from inventory
            this.state.player.equipped[slot] = itemKey;
            const index = this.state.player.inventory.indexOf(itemKey);
            if (index > -1) this.state.player.inventory.splice(index, 1);
            
            this.appendOutput(`你裝備了 ${itemData.name}。`);
            this.DOM.equipConfirmModal.classList.add('hidden');
            this.updateStatus();
            this.renderInventory(); // Refresh inventory list
        },

        unequipItem(slotKey) {
            const itemKey = this.state.player.equipped[slotKey];
            if (itemKey) {
                this.state.player.inventory.push(itemKey);
                this.state.player.equipped[slotKey] = null;
                this.appendOutput(`你卸下了 ${this.data.items[itemKey].name}。`);
                this.updateStatus();
            }
        },

        useItem(itemKey) {
            const itemData = this.data.items[itemKey];
            const effect = itemData.effect;
            if (!effect) return;

            let used = false;
            if (effect.type === 'heal') {
                if (this.state.player.hp < this.state.player.maxHp) {
                    this.state.player.hp = Math.min(this.state.player.maxHp, this.state.player.hp + effect.amount);
                    this.appendOutput(`你使用了 ${itemData.name}，恢復了 ${effect.amount} 點生命值！`);
                    used = true;
                } else {
                    this.appendOutput('你的生命值已滿。');
                }
            } else if (effect.type === 'teleportHome') {
                this.appendOutput(`你使用了 ${itemData.name}，一道光芒將你傳送回村莊。`);
                this.returnToVillage();
                used = true;
            }

            if (used) {
                const index = this.state.player.inventory.indexOf(itemKey);
                if (index > -1) this.state.player.inventory.splice(index, 1);
                this.updateStatus();
                if(this.state.gamePhase === 'inventory') this.renderInventory();
            }
        },

        buyItem(itemKey) {
            const itemData = this.data.items[itemKey];
            if (!itemData || typeof itemData.buy !== 'number') {
                console.error(`buyItem: Invalid item data for key: ${itemKey}`);
                return;
            }

            const playerGold = Number(this.state.player.gold);
            const itemPrice = Number(itemData.buy);

            if (playerGold >= itemPrice) {
                this.state.player.gold = playerGold - itemPrice;
                this.state.player.inventory.push(itemKey);
                this.appendOutput(`你購買了 ${itemData.name}。`);
                this.updateStatus();
                this.renderShop();
            } else {
                this.appendOutput('金幣不足！');
            }
        },

        sellItem(itemKey) {
            const itemData = this.data.items[itemKey];
            const index = this.state.player.inventory.indexOf(itemKey);
            if (index > -1) {
                this.state.player.inventory.splice(index, 1);
                this.state.player.gold += itemData.sell;
                this.appendOutput(`你賣掉了 ${itemData.name}，獲得 ${itemData.sell} 金幣。`);
                this.updateStatus();
                this.renderShop();
            }
        },

        // --- 9. Helper Functions ---
        calculatePlayerStats() {
            const p = this.state.player;
            let totalAttack = p.baseAttack;
            let totalDefense = p.baseDefense;
            for (const slot in p.equipped) {
                const itemKey = p.equipped[slot];
                if (itemKey && this.data.items[itemKey]) {
                    const itemData = this.data.items[itemKey];
                    totalAttack += itemData.attack || 0;
                    totalDefense += itemData.defense || 0;
                }
            }
            return { attack: totalAttack, defense: totalDefense };
        },
        
        getXpRequiredForLevel(level) {
            return Math.floor(100 + (level - 1) * 50);
        },

        appendOutput(message) {
            this.DOM.gameOutput.textContent += '\n' + message;
            this.DOM.gameOutput.scrollTop = this.DOM.gameOutput.scrollHeight;
        },

        setOutput(message) {
            this.DOM.gameOutput.textContent = message;
        },
    };

    window.onload = () => {
        try {
            Game.init();
        } catch (error) {
            console.error("遊戲初始化失敗:", error);
            document.body.innerHTML = `<div style="color: red; text-align: center; margin-top: 50px; font-size: 1.5rem;">遊戲載入失敗：${error.message}</div>`;
        }
    };
    </script>
</body>
</html>
